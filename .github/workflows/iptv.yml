name: IPTV Auto Update

on:
  schedule:
    - cron: '0 5,12,17 * * *'  # UTCæ—¶é—´5,12,17ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´13:00, 20:00, 01:00ï¼‰
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  TZ: Asia/Shanghai
  PYTHON_VERSION: '3.10'

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    # ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–è®¾ç½®
    - name: Checkout repository with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        echo "UPDATE_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    # ç¬¬äºŒé˜¶æ®µï¼šä¾èµ–å®‰è£…å’Œå‡†å¤‡
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg curl wget

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install requests beautifulsoup4 lxml
        fi

    # ç¬¬ä¸‰é˜¶æ®µï¼šæ‰§è¡ŒIPTVæ›´æ–°
    - name: Run IPTV update script
      id: run-script
      run: |
        echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒIPTVæ›´æ–°è„šæœ¬..."
        
        if [ -f "iptv.py" ]; then
          python iptv.py
          SCRIPT_EXIT_CODE=$?
        else
          echo "ğŸ“ ç”Ÿæˆç¤ºä¾‹IPTVæ–‡ä»¶..."
          # ç”Ÿæˆç¤ºä¾‹æ–‡ä»¶
          cat > iptv.txt << EOF
# IPTVæ’­æ”¾åˆ—è¡¨ - ç”Ÿæˆæ—¶é—´: $UPDATE_TIME
# æµç¨‹: æ™ºèƒ½æŠ“å– â†’ æµ‹é€Ÿè¿‡æ»¤ â†’ æ¨¡æ¿åŒ¹é… â†’ ç”Ÿæˆæ–‡ä»¶
# æ¯ä¸ªé¢‘é“æä¾›å¤šä¸ªå¤‡ç”¨æºï¼ŒæŒ‰é€Ÿåº¦æ’åº
# æ ¼å¼: é¢‘é“åç§°,ç›´æ’­æµåœ°å€

å¤®è§†é¢‘é“,#genre#
CCTV-1,http://example.com/cctv1.m3u8
CCTV-2,http://example.com/cctv2.m3u8

å«è§†é¢‘é“,#genre#
æ¹–å—å«è§†,http://example.com/hunan.m3u8
æµ™æ±Ÿå«è§†,http://example.com/zhejiang.m3u8
EOF
          
          # ç”ŸæˆM3Uæ–‡ä»¶
          cat > iptv.m3u << EOF
#EXTM3U
#PLAYLIST: IPTVæ™ºèƒ½åˆ—è¡¨
#GENERATED: $UPDATE_TIME

#EXTINF:-1 tvg-name="CCTV-1" group-title="å¤®è§†é¢‘é“",CCTV-1
http://example.com/cctv1.m3u8
#EXTINF:-1 tvg-name="æ¹–å—å«è§†" group-title="å«è§†é¢‘é“",æ¹–å—å«è§†
http://example.com/hunan.m3u8
EOF
          SCRIPT_EXIT_CODE=0
        fi
        
        echo "SCRIPT_EXIT_CODE=$SCRIPT_EXIT_CODE" >> $GITHUB_ENV
        if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SCRIPT_EXIT_CODE"
          exit $SCRIPT_EXIT_CODE
        fi

    # ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶éªŒè¯å’Œç»Ÿè®¡
    - name: Validate generated files
      id: validate-files
      run: |
        echo "ğŸ” å¼€å§‹éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        FILES_MISSING=0
        for file in iptv.txt iptv.m3u; do
          if [ ! -f "$file" ]; then
            echo "âŒ æ–‡ä»¶ç¼ºå¤±: $file"
            FILES_MISSING=1
          fi
        done
        
        if [ $FILES_MISSING -ne 0 ]; then
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å†…å®¹
        echo "ğŸ“Š æ–‡ä»¶å†…å®¹æ£€æŸ¥:"
        TXT_LINES=$(wc -l < iptv.txt || echo "0")
        M3U_LINES=$(wc -l < iptv.m3u || echo "0")
        
        echo "TXT_LINES=$TXT_LINES" >> $GITHUB_ENV
        echo "M3U_LINES=$M3U_LINES" >> $GITHUB_ENV
        
        if [ $TXT_LINES -lt 5 ] || [ $M3U_LINES -lt 5 ]; then
          echo "âŒ æ–‡ä»¶å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"

    - name: Generate statistics
      id: generate-stats
      run: |
        echo "ğŸ“ˆ ç”Ÿæˆé¢‘é“ç»Ÿè®¡..."
        
        # ç»Ÿè®¡é¢‘é“æ•°é‡
        CCTV_COUNT=$(grep -c "CCTV" iptv.txt 2>/dev/null || echo "0")
        WS_COUNT=$(grep -v "CCTV" iptv.txt | grep -c ",http" 2>/dev/null || echo "0")
        MOVIE_COUNT=$(grep -E "(ç”µå½±|CHC|æ­¦ä¾ |çŒ«å’Œè€é¼ )" iptv.txt | grep -c ",http" 2>/dev/null || echo "0")
        TOTAL_COUNT=$((CCTV_COUNT + WS_COUNT + MOVIE_COUNT))
        
        echo "CCTV_COUNT=$CCTV_COUNT" >> $GITHUB_ENV
        echo "WS_COUNT=$WS_COUNT" >> $GITHUB_ENV
        echo "MOVIE_COUNT=$MOVIE_COUNT" >> $GITHUB_ENV
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        
        echo "ğŸ“Š ç»Ÿè®¡å®Œæˆ:"
        echo "  å¤®è§†é¢‘é“: $CCTV_COUNT"
        echo "  å«è§†é¢‘é“: $WS_COUNT"
        echo "  ç”µå½±ä¸“é¢˜: $MOVIE_COUNT"
        echo "  æ€»è®¡: $TOTAL_COUNT"

    # ç¬¬äº”é˜¶æ®µï¼šç”ŸæˆREADME
    - name: Generate README
      run: |
        echo "ğŸ“ ç”ŸæˆREADMEæ–‡ä»¶..."
        
        cat > README.md << EOF
# ğŸ“º IPTVç›´æ’­æºè‡ªåŠ¨æ›´æ–°

## âœ¨ æœ€åæ›´æ–°: $UPDATE_TIME

## ğŸ“Š é¢‘é“ç»Ÿè®¡
- **æ€»é¢‘é“æ•°**: $TOTAL_COUNT ä¸ª
- **å¤®è§†é¢‘é“**: $CCTV_COUNT ä¸ª
- **å«è§†é¢‘é“**: $WS_COUNT ä¸ª  
- **ç”µå½±ä¸“é¢˜**: $MOVIE_COUNT ä¸ª

## ğŸ“ æ–‡ä»¶ä¿¡æ¯
- **iptv.txt**: $TXT_LINES è¡Œ (CSVæ ¼å¼)
- **iptv.m3u**: $M3U_LINES è¡Œ (M3Uæ ¼å¼)

## ğŸš€ å¿«é€Ÿä½¿ç”¨
### æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨
\`\`\`bash
# ä¸‹è½½æ’­æ”¾åˆ—è¡¨
curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.txt
curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.m3u
\`\`\`

### æ–¹æ³•äºŒï¼šæ’­æ”¾å™¨åŠ è½½
- **VLC**: åª’ä½“ â†’ æ‰“å¼€ç½‘ç»œä¸²æµ â†’ ç²˜è´´URL
- **PotPlayer**: æ‰“å¼€ â†’ æ‰“å¼€é“¾æ¥
- **æ”¯æŒM3Uæ ¼å¼çš„ä»»ä½•æ’­æ”¾å™¨**

## ğŸ“‹ æ–‡ä»¶è¯´æ˜
| æ–‡ä»¶å | æ ¼å¼ | æè¿° | æ¨èæ’­æ”¾å™¨ |
|--------|------|------|------------|
| \`iptv.txt\` | CSV | ç®€æ´æ ¼å¼ï¼Œå…¼å®¹æ€§å¼º | æ‰€æœ‰æ’­æ”¾å™¨ |
| \`iptv.m3u\` | M3U | æ ‡å‡†æ ¼å¼ï¼ŒåŒ…å«å…ƒæ•°æ® | VLC, Kodiç­‰ |

## âš¡ æ›´æ–°é¢‘ç‡
- **è‡ªåŠ¨æ›´æ–°**: æ¯æ—¥3æ¬¡ (13:00, 20:00, 01:00 åŒ—äº¬æ—¶é—´)
- **æ‰‹åŠ¨æ›´æ–°**: ç‚¹å‡» Actions â†’ Update IPTV â†’ Run workflow

## ğŸ”§ æŠ€æœ¯æ”¯æŒ
å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. å°è¯•ä¸åŒçš„æº
3. æäº¤ [Issue](${{ github.server_url }}/${{ github.repository }}/issues)

## âš ï¸ å…è´£å£°æ˜
> ğŸ“¢ æœ¬èµ„æºä»…ä¾›å­¦ä¹ äº¤æµå’ŒæŠ€æœ¯ç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œç¦æ­¢å•†ä¸šç”¨é€”ã€‚

## ğŸ’– æ”¯æŒé¡¹ç›®
å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ï¼š
- â­ **Star** è¿™ä¸ªä»“åº“
- ğŸ”„ **Fork** é¡¹ç›®
- ğŸ› æäº¤ **Issue** å’Œ **Feature Request**
- ğŸ“¢ åˆ†äº«ç»™æ›´å¤šéœ€è¦çš„äºº

---

*æœ€åè‡ªåŠ¨ç”Ÿæˆäº: $UPDATE_TIME*  
*æœ¬æ¬¡æ›´æ–°è€—æ—¶: $(( $(date +%s) - $START_TIME )) ç§’*
EOF

        echo "âœ… READMEç”Ÿæˆå®Œæˆ"

    # ç¬¬å…­é˜¶æ®µï¼šGitæ“ä½œå’Œæ¨é€
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global pull.rebase true

    - name: Pull latest changes
      run: |
        echo "ğŸ”„ æ‹‰å–æœ€æ–°æ›´æ”¹..."
        git pull origin main --no-rebase --no-edit || true

    - name: Stage changes
      run: |
        echo "ğŸ“¦ æš‚å­˜æ›´æ”¹æ–‡ä»¶..."
        git add iptv.txt iptv.m3u README.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "ğŸŸ¡ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        else
          echo "âœ… æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        fi

    - name: Commit and push changes
      if: env.HAS_CHANGES == 'true'
      run: |
        echo "ğŸš€ æäº¤å¹¶æ¨é€æ›´æ”¹..."
        git commit -m "ğŸ”„ IPTVè‡ªåŠ¨æ›´æ–° - $UPDATE_TIME (é¢‘é“: $TOTAL_COUNT)"
        
        # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if git push origin main; then
            echo "âœ… æ¨é€æˆåŠŸ"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "ğŸ”„ æ¨é€å¤±è´¥ï¼Œå°è¯•ç¬¬ $RETRY_COUNT æ¬¡é‡è¯•..."
            sleep 5
            git pull origin main --rebase
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "âŒ æ¨é€å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
          exit 1
        fi

    # ç¬¬ä¸ƒé˜¶æ®µï¼šåç»­å¤„ç†å’Œæ¸…ç†
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iptv-files-${{ github.run_id }}
        path: |
          iptv.txt
          iptv.m3u
          README.md
        retention-days: 7

    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ“Š IPTVæ›´æ–°ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ• æ›´æ–°æ—¶é—´: $UPDATE_TIME" >> $GITHUB_STEP_SUMMARY
        echo "### â±ï¸ è€—æ—¶: $(( $(date +%s) - $START_TIME )) ç§’" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ é¢‘é“ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»é¢‘é“æ•°**: $TOTAL_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤®è§†é¢‘é“**: $CCTV_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- **å«è§†é¢‘é“**: $WS_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- **ç”µå½±ä¸“é¢˜**: $MOVIE_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ æ–‡ä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **iptv.txt**: $TXT_LINES è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "- **iptv.m3u**: $M3U_LINES è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.HAS_CHANGES }}" = "true" ]; then
          echo "### âœ… æ›´æ–°çŠ¶æ€: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "æ›´æ”¹å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ æ›´æ–°çŠ¶æ€: æ— æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "æœªæ£€æµ‹åˆ°å†…å®¹æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ IPTVæ›´æ–°å®Œæˆï¼"
        echo "ğŸ“Š æ€»è®¡ $TOTAL_COUNT ä¸ªé¢‘é“"
        echo "ğŸ• è€—æ—¶: $(( $(date +%s) - $START_TIME )) ç§’"

    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ IPTVæ›´æ–°å¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        exit 1

  # å¯é€‰çš„åç»­å·¥ä½œï¼ˆå¦‚éƒ¨ç½²åˆ°GitHub Pagesï¼‰
  deploy-pages:
    runs-on: ubuntu-latest
    needs: update-iptv
    if: success()
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
