name: Update IPTV

on:
  schedule:
    - cron: '0 5,12,17 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'iptv.py'
      - 'requirements.txt'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  PYTHON_VERSION: '3.10'

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup timezone
      uses: zcong1993/setup-timezone@master
      with:
        timezone: Asia/Shanghai

    - name: Get current time
      id: time
      uses: josStorer/get-current-time@v2.0.2
      with:
        format: 'YYYY-MM-DD HH:mm:ss'
        utcOffset: '+08:00'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

    - name: Run IPTV update script
      id: run-script
      run: |
        echo "Running IPTV update script..."
        python iptv.py
        
        # æ£€æŸ¥æ–‡ä»¶å¹¶ç»Ÿè®¡è¡Œæ•°
        if [ -f "iptv.txt" ] && [ -f "iptv.m3u" ]; then
          LINES_TXT=$(wc -l < iptv.txt | tr -d ' ' || echo "0")
          LINES_M3U=$(wc -l < iptv.m3u | tr -d ' ' || echo "0")
          echo "lines_txt=$LINES_TXT" >> $GITHUB_OUTPUT
          echo "lines_m3u=$LINES_M3U" >> $GITHUB_OUTPUT
          echo "âœ“ Files generated successfully: txt=$LINES_TXT lines, m3u=$LINES_M3U lines"
        else
          echo "âŒ Error: IPTV files were not generated"
          exit 1
        fi

    - name: Get file sizes
      id: file-size
      run: |
        if [ -f "iptv.txt" ]; then
          SIZE_TXT=$(du -h iptv.txt | cut -f1)
          echo "size_txt=$SIZE_TXT" >> $GITHUB_OUTPUT
        else
          echo "size_txt=0B" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "iptv.m3u" ]; then
          SIZE_M3U=$(du -h iptv.m3u | cut -f1)
          echo "size_m3u=$SIZE_M3U" >> $GITHUB_OUTPUT
        else
          echo "size_m3u=0B" >> $GITHUB_OUTPUT
        fi

    - name: Update README
      run: |
        cat > README.md << EOF
# IPTV ç›´æ’­æºä»“åº“

## ðŸ“¢ å…è´£å£°æ˜Ž

1. æœ¬ä»“åº“ä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œè¯·å°Šé‡ç‰ˆæƒï¼Œè¯·å‹¿åˆ©ç”¨æ­¤ä»“åº“ä»Žäº‹å•†ä¸šè¡Œä¸ºåŠéžæ³•ç”¨é€”ï¼

2. ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿç‰ˆæƒæ•°æ®ã€‚å¯¹äºŽè¿™äº›ç‰ˆæƒæ•°æ®ï¼Œæœ¬ä»“åº“ä¸æ‹¥æœ‰å®ƒä»¬çš„æ‰€æœ‰æƒã€‚ä¸ºäº†é¿å…ä¾µæƒï¼Œä½¿ç”¨è€…åŠ¡å¿…åœ¨24å°æ—¶å†…æ¸…é™¤ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ç‰ˆæƒæ•°æ®ã€‚

3. ç”±äºŽä½¿ç”¨æœ¬ä»“åº“äº§ç”Ÿçš„åŒ…æ‹¬ç”±äºŽæœ¬åè®®æˆ–ç”±äºŽä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬ä»“åº“è€Œå¼•èµ·çš„ä»»ä½•æ€§è´¨çš„ä»»ä½•ç›´æŽ¥ã€é—´æŽ¥ã€ç‰¹æ®Šã€å¶ç„¶æˆ–ç»“æžœæ€§æŸå®³ç”±ä½¿ç”¨è€…è´Ÿè´£ã€‚

4. ç¦æ­¢åœ¨è¿åå½“åœ°æ³•å¾‹æ³•è§„çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“ã€‚å¯¹äºŽä½¿ç”¨è€…åœ¨æ˜ŽçŸ¥æˆ–ä¸çŸ¥å½“åœ°æ³•å¾‹æ³•è§„ä¸å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“æ‰€é€ æˆçš„ä»»ä½•è¿æ³•è¿è§„è¡Œä¸ºç”±ä½¿ç”¨è€…æ‰¿æ‹…ã€‚

5. å¦‚æžœå®˜æ–¹å¹³å°è§‰å¾—æœ¬ä»“åº“ä¸å¦¥ï¼Œå¯è”ç³»æœ¬ä»“åº“æ›´æ”¹æˆ–ç§»é™¤ã€‚

## ðŸ“Š ä»“åº“çŠ¶æ€

- **æœ€åŽæ›´æ–°**: ${{ steps.time.outputs.formattedTime }} (åŒ—äº¬æ—¶é—´)
- **ç›´æ’­æºæ•°é‡**:
  - iptv.txt: ${{ steps.run-script.outputs.lines_txt }} è¡Œ
  - iptv.m3u: ${{ steps.run-script.outputs.lines_m3u }} è¡Œ
- **æ–‡ä»¶å¤§å°**:
  - iptv.txt: ${{ steps.file-size.outputs.size_txt }}
  - iptv.m3u: ${{ steps.file-size.outputs.size_m3u }}

## ðŸ“¥ ä¸‹è½½é“¾æŽ¥

### ç›´é“¾ä¸‹è½½
- [iptv.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.txt)
- [iptv.m3u](https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.m3u)

### GitHub Raw é“¾æŽ¥
- [iptv.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.txt)
- [iptv.m3u](https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.m3u)

## âš¡ ä½¿ç”¨è¯´æ˜Ž

1. **æ’­æ”¾å™¨ä½¿ç”¨**: å°†ä¸Šè¿°é“¾æŽ¥å¤åˆ¶åˆ°æ”¯æŒ M3U æ ¼å¼çš„æ’­æ”¾å™¨ä¸­ä½¿ç”¨
2. **æ–‡æœ¬æ ¼å¼**: iptv.txt ä¸ºçº¯æ–‡æœ¬æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªé¢‘é“é“¾æŽ¥
3. **M3U æ ¼å¼**: iptv.m3u ä¸ºæ ‡å‡† M3U æ’­æ”¾åˆ—è¡¨æ ¼å¼

## ðŸ”„ è‡ªåŠ¨æ›´æ–°

æœ¬ä»“åº“æ¯å¤©è‡ªåŠ¨æ›´æ–°ä¸‰æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 13:00, 20:00, æ¬¡æ—¥ 01:00ï¼‰

## â­ æ”¯æŒé¡¹ç›®

å¦‚æžœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ï¼

---
*æ›´æ–°æ—¶é—´: ${{ steps.time.outputs.formattedTime }}*
EOF

        echo "âœ“ README.md updated successfully"

    - name: Validate changes
      run: |
        echo "Validating generated files..."
        if [ -s "iptv.txt" ] && [ -s "iptv.m3u" ] && [ -s "README.md" ]; then
          echo "âœ“ All files are valid"
          echo "File preview:"
          head -n 5 iptv.txt iptv.m3u
        else
          echo "âŒ File validation failed"
          exit 1
        fi

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git commit -m "ðŸ”„ Auto-update IPTV sources at ${{ steps.time.outputs.formattedTime }}
          
- Updated IPTV sources
- iptv.txt: ${{ steps.run-script.outputs.lines_txt }} lines (${{ steps.file-size.outputs.size_txt }})
- iptv.m3u: ${{ steps.run-script.outputs.lines_m3u }} lines (${{ steps.file-size.outputs.size_m3u }})"
          git push
        fi
