name: Update

on:
  schedule:
    - cron: '0 5,12,17 * * *'  # UTCæ—¶é—´5,12,17ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´13,20,01ç‚¹ï¼‰
  workflow_dispatch:

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: Get Beijing time
      run: echo "UPDATE_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Run IPTV script
      run: |
        python iptv.py
        # ç¡®ä¿è„šæœ¬ç”Ÿæˆæ‰€éœ€æ–‡ä»¶
        if [ ! -f "iptv.txt" ]; then echo "Error: iptv.txt not generated" && exit 1; fi
        if [ ! -f "iptv.m3u" ]; then echo "Error: iptv.m3u not generated" && exit 1; fi

    - name: Generate updated README
      run: |
        # ç»Ÿè®¡é¢‘é“æ•°é‡
        CCTV_COUNT=$(grep -c "CCTV-" iptv.txt || true)
        WS_COUNT=$(grep -v "CCTV-" iptv.txt | grep -c ",http" || true)
        MOVIE_COUNT=$(grep -E "(ç”µå½±|CHC|æ­¦ä¾ |çŒ«å’Œè€é¼ )" iptv.txt | grep -c ",http" || true)
        
        echo "# ğŸ“º IPTVç›´æ’­æºè‡ªåŠ¨æ›´æ–°
        
## âœ¨ æœ€åæ›´æ–°äº: $UPDATE_TIME
**ğŸ‰ æœ€æ–°å¯ç”¨IPTVæºï¼Œè§‰å¾—å¥½ç”¨è¯·ç‚¹ä¸ªSTARæ”¯æŒï¼**

### ğŸ“Š é¢‘é“ç»Ÿè®¡
- **å¤®è§†é¢‘é“**: $CCTV_COUNT ä¸ª
- **å«è§†é¢‘é“**: $WS_COUNT ä¸ª  
- **ç”µå½±ä¸“é¢˜**: $MOVIE_COUNT ä¸ª

### ğŸ“ æ–‡ä»¶è¯´æ˜
1. **iptv.txt** - ç®€æ´CSVæ ¼å¼ï¼Œå…¼å®¹å„ç§æ’­æ”¾å™¨
2. **iptv.m3u** - æ ‡å‡†M3Uæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´å…ƒæ•°æ®

### âš¡ ä½¿ç”¨è¯´æ˜
ç›´æ¥å°†é“¾æ¥å¤åˆ¶åˆ°æ”¯æŒIPTVçš„æ’­æ”¾å™¨ä¸­ä½¿ç”¨ï¼š
- æ”¯æŒï¼šVLCã€PotPlayerã€Kodiç­‰
- æ ¼å¼ï¼šé¢‘é“åç§°,ç›´æ’­æµåœ°å€

### ğŸ”„ æ›´æ–°é¢‘ç‡
æ¯æ—¥è‡ªåŠ¨æ›´æ–°3æ¬¡ï¼ˆUTC 5:00, 12:00, 17:00ï¼‰

### âš ï¸ å…è´£å£°æ˜
æœ¬èµ„æºä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”

**ğŸ’– å¦‚æœå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStaræ”¯æŒä¸€ä¸‹ï¼**
" > README.md

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit changes
      run: |
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
        git pull origin main --rebase --autostash
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
        git add iptv.txt iptv.m3u README.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ IPTVè‡ªåŠ¨æ›´æ–° - $UPDATE_TIME"
        fi

    - name: Push changes safely
      run: |
        # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™å¼ºåˆ¶æ¨é€ï¼ˆåœ¨è‡ªåŠ¨æ›´æ–°åœºæ™¯ä¸‹å®‰å…¨ï¼‰
        if ! git push origin main; then
          echo "Push failed, pulling latest changes and retrying..."
          git pull origin main --rebase
          git push origin main
        fi

    - name: Verify push success
      run: |
        echo "âœ… æ›´æ–°å®Œæˆäº $UPDATE_TIME"
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        ls -la iptv.*
        wc -l iptv.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iptv-files
        path: |
          iptv.txt
          iptv.m3u
          README.md
