name: Tv_search

on:
  workflow_dispatch:
    inputs:
      speed_threshold:
        description: 'é€Ÿåº¦é˜ˆå€¼ (MB/s)'
        required: true
        default: '1.0'
        type: string
      categories:
        description: 'é¢‘é“åˆ†ç±» (é€—å·åˆ†éš”)'
        required: true
        default: 'å¤®è§†é¢‘é“'
        type: string
  schedule:
    - cron: '0 5 * * *'
    - cron: '0 12 * * *'
    - cron: '0 17 * * *'
  push:
    branches: [ main, master ]
    paths:
      - '**.py'
      - '**.txt'
      - '.github/workflows/**'

env:
  PYTHON_VERSION: '3.9'
  MAX_RETRIES: 3
  WORKFLOW_TIMEOUT_MINUTES: 45

jobs:
  crawl-tv-streams:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.WORKFLOW_TIMEOUT_MINUTES }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip xvfb libxss1 libappindicator1 libindicator7
        
        # å®‰è£…å­—ä½“æ”¯æŒä¸­æ–‡æ˜¾ç¤º
        sudo apt-get install -y fonts-wqy-microhei fonts-wqy-zenhei

    - name: Install Chrome and ChromeDriver
      run: |
        # å®‰è£… Chrome
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # è·å– Chrome ç‰ˆæœ¬å¹¶ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ ChromeDriver
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAJOR_VERSION")
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests lxml selenium webdriver-manager
        pip install retrying python-dotenv

    - name: Create channel list files
      run: |
        # åˆ›å»ºç¤ºä¾‹é¢‘é“æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "å¤®è§†é¢‘é“.txt" ]; then
          cat > "å¤®è§†é¢‘é“.txt" << EOF
CCTV1
CCTV2
CCTV5
CCTV6
CCTV8
æ¹–å—å«è§†
æµ™æ±Ÿå«è§†
ä¸œæ–¹å«è§†
æ±Ÿè‹å«è§†
åŒ—äº¬å«è§†
EOF
        fi
        
        # æ ¹æ®è¾“å…¥å‚æ•°åˆ›å»ºå…¶ä»–é¢‘é“æ–‡ä»¶
        IFS=',' read -ra CATEGORIES <<< "${{ github.event.inputs.categories || 'å¤®è§†é¢‘é“' }}"
        for category in "${CATEGORIES[@]}"; do
          if [ ! -f "${category}.txt" ]; then
            echo "åˆ›å»ºé»˜è®¤ ${category}.txt æ–‡ä»¶"
            echo "é¢‘é“1" > "${category}.txt"
            echo "é¢‘é“2" >> "${category}.txt"
          fi
        done

    - name: Run TV Search crawler
      id: run_crawler
      env:
        SPEED_THRESHOLD: ${{ github.event.inputs.speed_threshold || '1.0' }}
        CATEGORIES: ${{ github.event.inputs.categories || 'å¤®è§†é¢‘é“' }}
        HTTP_PROXY: ${{ secrets.PROXY_SERVER }}
        MAX_RETRIES: ${{ env.MAX_RETRIES }}
      run: |
        echo "ğŸ¬ å¼€å§‹æ‰§è¡ŒTv_search"
        echo "ğŸ“Š è¿è¡Œå‚æ•°:"
        echo "  é€Ÿåº¦é˜ˆå€¼: $SPEED_THRESHOLD MB/s"
        echo "  é¢‘é“åˆ†ç±»: $CATEGORIES"
        echo "  ä»£ç†è®¾ç½®: ${HTTP_PROXY:-æ— }"
        echo "  æœ€å¤§é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
        echo "  å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # å¸¦é‡è¯•æœºåˆ¶çš„è¿è¡Œ
        for i in $(seq 1 $MAX_RETRIES); do
          echo "ğŸ”„ å°è¯•ç¬¬ $i æ¬¡è¿è¡Œ..."
          python Tv_search.py && break || sleep 30
        done

        # è®¾ç½®è¾“å‡ºå˜é‡
        if [ -f "live.txt" ]; then
          LINE_COUNT=$(wc -l < live.txt)
          echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
          echo "file_exists=true" >> $GITHUB_OUTPUT
        else
          echo "file_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload live streams file
      if: steps.run_crawler.outputs.file_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tv-live-streams-${{ github.run_id }}
        path: |
          live.txt
          tv_search.log
          tv_search_debug.log
        retention-days: 7

    - name: Commit and push if changed
      if: steps.run_crawler.outputs.file_exists == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        git add live.txt
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°ç›´æ’­æºå˜åŒ–"
        else
          git commit -m "ğŸ”„ Tv_searchè‡ªåŠ¨æ›´æ–°ç›´æ’­æº [$(date +'%Y-%m-%d %H:%M')] - æ‰¾åˆ° ${{ steps.run_crawler.outputs.line_count }} ä¸ªæº"
          git push
          echo "ğŸš€ ç”µè§†ç›´æ’­æºå·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          echo "ğŸ“Š æœ¬æ¬¡æ›´æ–°æœ‰æ•ˆç›´æ’­æº: ${{ steps.run_crawler.outputs.line_count }} ä¸ª"
        fi

    - name: Send success notification
      if: success() && steps.run_crawler.outputs.file_exists == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âœ… TVæœç´¢æˆåŠŸå®Œæˆï¼\næ‰¾åˆ° ${{ steps.run_crawler.outputs.line_count }} ä¸ªæœ‰æ•ˆç›´æ’­æº\nå·¥ä½œæµè¿è¡Œ: ${{ github.run_id }}`
          });

    - name: Send failure notification
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âŒ TVæœç´¢æ‰§è¡Œå¤±è´¥ï¼\nå·¥ä½œæµè¿è¡Œ: ${{ github.run_id }}\nè¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯`
          });
