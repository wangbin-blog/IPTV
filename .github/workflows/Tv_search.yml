name: Tv_search

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      speed_threshold:
        description: 'é€Ÿåº¦é˜ˆå€¼ (MB/s)'
        required: true
        default: '1.0'
        type: string
      categories:
        description: 'é¢‘é“åˆ†ç±» (é€—å·åˆ†éš”)'
        required: true
        default: 'å¤®è§†é¢‘é“'
        type: string
  schedule:
    # æ¯å¤©5ç‚¹ã€12ç‚¹ã€17ç‚¹è‡ªåŠ¨è¿è¡Œ (UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´13ç‚¹ã€20ç‚¹ã€æ¬¡æ—¥1ç‚¹)
    - cron: '0 5 * * *'
    - cron: '0 12 * * *'
    - cron: '0 17 * * *'
  push:
    branches: [ main, master ]
    paths:
      - '**.py'
      - '**.txt'
      - '.github/workflows/**'

jobs:
  crawl-tv-streams:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip

    - name: Install Chrome and ChromeDriver
      run: |
        # å®‰è£… Chrome
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # è·å– Chrome ç‰ˆæœ¬å¹¶ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ ChromeDriver
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_MAJOR_VERSION")
        wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests lxml selenium

    - name: Create channel list files
      run: |
        # åˆ›å»ºç¤ºä¾‹é¢‘é“æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "å¤®è§†é¢‘é“.txt" ]; then
          cat > "å¤®è§†é¢‘é“.txt" << EOF
          CCTV1
          CCTV2
          CCTV5
          CCTV6
          CCTV8
         æ¹–å—å«è§†
         æµ™æ±Ÿå«è§†
         ä¸œæ–¹å«è§†
         æ±Ÿè‹å«è§†
         åŒ—äº¬å«è§†
        EOF
        fi
        
        # æ ¹æ®è¾“å…¥å‚æ•°åˆ›å»ºå…¶ä»–é¢‘é“æ–‡ä»¶
        IFS=',' read -ra CATEGORIES <<< "${{ github.event.inputs.categories || 'å¤®è§†é¢‘é“' }}"
        for category in "${CATEGORIES[@]}"; do
          if [ ! -f "${category}.txt" ]; then
            echo "åˆ›å»ºé»˜è®¤ ${category}.txt æ–‡ä»¶"
            echo "é¢‘é“1" > "${category}.txt"
            echo "é¢‘é“2" >> "${category}.txt"
          fi
        done

    - name: Run TV Search crawler
      env:
        SPEED_THRESHOLD: ${{ github.event.inputs.speed_threshold || '1.0' }}
        CATEGORIES: ${{ github.event.inputs.categories || 'å¤®è§†é¢‘é“' }}
      run: |
        echo "ğŸ¬ å¼€å§‹æ‰§è¡ŒTv_search"
        echo "ğŸ“Š è¿è¡Œå‚æ•°:"
        echo "  é€Ÿåº¦é˜ˆå€¼: $SPEED_THRESHOLD MB/s"
        echo "  é¢‘é“åˆ†ç±»: $CATEGORIES"
        echo "  å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # è¿è¡ŒTVæœç´¢è„šæœ¬
        python Tv_search.py

    - name: Check if live.txt was created
      id: check_live
      run: |
        if [ -f "live.txt" ]; then
          LINE_COUNT=$(wc -l < live.txt)
          echo "âœ… ç›´æ’­æºæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“„ æ–‡ä»¶è¡Œæ•°: $LINE_COUNT"
          echo "ğŸ“‹ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          echo "======================"
          head -15 live.txt
          echo "======================"
        else
          echo "âŒ ç›´æ’­æºæ–‡ä»¶æœªåˆ›å»º"
          echo "file_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload live streams file
      if: steps.check_live.outputs.file_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tv-live-streams-${{ github.run_id }}
        path: |
          live.txt
          tv_search.log
        retention-days: 3

    - name: Commit and push if changed
      if: steps.check_live.outputs.file_exists == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        git add live.txt
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°ç›´æ’­æºå˜åŒ–"
        else
          git commit -m "ğŸ”„ Tv_searchè‡ªåŠ¨æ›´æ–°ç›´æ’­æº [$(date +'%Y-%m-%d %H:%M')] - æ‰¾åˆ° ${{ steps.check_live.outputs.line_count }} ä¸ªæº"
          git push
          echo "ğŸš€ ç”µè§†ç›´æ’­æºå·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          echo "ğŸ“Š æœ¬æ¬¡æ›´æ–°æœ‰æ•ˆç›´æ’­æº: ${{ steps.check_live.outputs.line_count }} ä¸ª"
        fi

    - name: Success notification
      if: success() && steps.check_live.outputs.file_exists == 'true'
      run: |
        echo "ğŸ‰ Tv_searchæ‰§è¡ŒæˆåŠŸï¼"
        echo "ğŸ“ˆ æ‰¾åˆ° ${{ steps.check_live.outputs.line_count }} ä¸ªæœ‰æ•ˆç›´æ’­æº"
        echo "ğŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ Tv_searchæ‰§è¡Œå¤±è´¥ï¼"
        echo "ğŸ• å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        exit 1

    - name: Clean up logs
      if: always()
      run: |
        # æ¸…ç†æ—¥å¿—æ–‡ä»¶
        if [ -f "tv_search.log" ]; then
          rm tv_search.log
        fi
        if [ -f "video.ts" ]; then
          rm video.ts
        fi
